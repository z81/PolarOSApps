(function(){var c,b,e,a={}.hasOwnProperty,d=function(i,g){for(var f in g){if(a.call(g,f)){i[f]=g[f]}}function h(){this.constructor=i}h.prototype=g.prototype;i.prototype=new h();i.__super__=g.prototype;return i};b=(function(g){d(f,g);function f(){e=f.__super__.constructor.apply(this,arguments);return e}return f})(window.PixiAdapter);window.getConf=function(){return Scheme.getConf()};c=(function(){function f(){}f.getConf=function(k,n){var i,j,m,l,h,g;if(n==null){n=true}j={};$.ajax({url:"hiasm/delphi_utf/conf/"+k+".ini",async:false}).success(function(o){return j=parseINIString(o)});if(j.Type&&j.Type.Inherit){g=j.Type.Inherit.split(",");for(l=0,h=g.length;l<h;l++){i=g[l];m=this.getConf(i,false);j.Property=angular.extend(j.Property,m.Property);j.Methods=angular.extend(j.Methods,m.Methods)}}if(n){return this.parse(j)}else{return j}};f.parse=function(i){var l,h,k,g,j;for(h in i.Property){k={};k.doWork=h.indexOf("@")>-1;k["default"]=h.indexOf("+">-1);k.name=h.replace(/[@|\+]/gmi,"");g=i.Property[h].split("|"),k.description=g[0],k.type=g[1],k.value=g[2],k.list=g[3];delete i.Property[h];i.Property[k.name]=k}for(h in i.Methods){l={};l.noVisible=h.indexOf("*");l.Name=h.replace(/[\*]/gmi,"");j=i.Methods[h].split("|"),l.description=j[0],l.type=j[1],l.value=j[2];delete i.Methods[h];i.Methods[l.Name]=l}return i};return f})();window.Scheme=(function(){var h,j,f,i;function g(){}i="1";j="2";h="3";f="4";g.getConf=function(){return window.scheme_conf};g.newPath=function(n,k,o,m,l){var p;p=[];if(l===g.getConf().link.color.events){if(k-m!==0){if(n<o){p=[n+(o-n)/2,k,n+(o-n)/2,m]}else{p=[n+10,k,n+10,k+30,o-10,k+30,o-10,m]}}}else{if(n-o!==0){if(k<m){p=[n,k+(m-k)/2,o,k+(m-k)/2]}else{p=[n,k+10,n+(o-n)+12,k+10,o+12,m-(m-k)/2,o-(o-n)/2,m-(m-k)/2,o-(o-n)/2,m-10,o,m-10]}}}return p};g.selectElement=function(k){console.log(k);g.selected_element=k;return angular.element("body").scope().onSelectElement()};g.mouseup=function(k){this.mousemove(k);return g.is_drag=false};g.elementDblclick=function(l,k){if(k.Root_paper){$("#scheme0").toggle();return $("#scheme"+k.Id).toggle()}};g.closeContainer=function(){$("#scheme *").hide();return $("#scheme0").show()};g.mousemove=function(s){var m,r,p,k,u,q,o,w,t,n,v,l;if(g.create_link){this.createNewLink(s,g.create_link.dot1)}if(g.is_drag){w=s.originalEvent.layerX-g.drag_start_pos[0];t=s.originalEvent.layerY-g.drag_start_pos[1];k=g.selected_element;if(g.selected_element._.links){l=g.selected_element._.links;for(n=0,v=l.length;n<v;n++){u=l[n];r=u.dot1._.visual;p=u.dot2._.visual;q=b.getRealDotPosition(r);o=b.getRealDotPosition(p);if(u.dot1.type===j||u.dot1.type===i){m=g.getConf().link.color.events}else{m=g.getConf().link.color.vars}u.clear();g.selected_element._.paper.drawLink(q,o,m,u)}}return b.moveElement(k,w,t)}};g.saveNewLink=function(m,n){var l,k,o;o=g.create_link.dot1;l=o.type<3;k=n.type<3;console.log(l,k);if(l===k&&o.type!==n.type){g.create_link.dot2=n;n._.element._.links.push(g.create_link);o._.element._.links.push(g.create_link);return g.create_link=void 0}};g.createNewLink=function(n,l){var k,m;m=b.getRealDotPosition(l._.visual);if(l.type===j||l.type===i){k=g.getConf().link.color.events}else{k=g.getConf().link.color.vars}if(g.create_link){g.create_link.clear();l._.paper.drawLink(m,[n.global.x,n.global.y],k,g.create_link)}else{g.create_link=l._.paper.drawLink(m,[n.global.x,n.global.y],k)}g.create_link.dot1=l;return g.create_link};g.newLink=function(l,k){if(!g.create_link){return this.createNewLink(l,k)}else{return this.saveNewLink(l,k)}};g.mousedown=function(l,k){g.selectElement(k);return g.is_drag=true};g.prototype.load=function(u){var t=new Stats();t.setMode(0);t.domElement.style.position="fixed";t.domElement.style.left="0px";t.domElement.style.bottom="40px";document.body.appendChild(t.domElement);setInterval(function(){t.begin();t.end()},1000/60);var p,l,s,k,m,n,x,r,w,q,v,o;x=ShaParser.getInstance().Parse(u);this.sdk=x.sdk;r=x.sortedElements;this.paper=new b();for(q=0,v=r.length;q<v;q++){s=r[q];if(!s._Container&&!s._Root){if(n&&!s._Root){this.paper=n}this.createElement(s)}else{if(s._Container){this.createElement(s);n=this.paper;this.paper=new b("#scheme",false,s.Id);s.Root_paper=this.paper}else{this.paper=s._Root.Root_paper;this.createElement(s)}}}for(l in this.sdk.Elements){s=this.sdk.Elements[l];for(k in s.Methods){k=s.Methods[k];if(k.to&&k.noVisible){console.info(k)}if(k.noVisible===-1){if(k.to){w={};o=k.to.split(":"),w.Id=o[0],w.Name=o[1];w.Element=this.sdk.Elements[w.Id];for(m in w.Element.Methods){m=w.Element.Methods[m];if(m.Name===w.Name){w.Method=m;break}}if(k.type===j||k.type===i){p=g.getConf().link.color.events}else{p=g.getConf().link.color.vars}this.drawLink(k,w,p)}}}}return console.log("SDK",this.sdk)};g.prototype.createElement=function(n){var o,m,r,q,k,p,l;this.sdk.Elements[n.Id]=n;this.addElement(n);m=[0,0,0,0,0,0];l=[];for(r in n.Methods){r=n.Methods[r];if(r.noVisible===-1){r._={element:n};q=r.type;k=n.X;p=n.Y;o=g.getConf().dot.color;if(q===j){k=k+n._.size}if(q===j||q===i){p=p+g.getConf().dot.indent+m[r.type]*g.getConf().dot.offset}if(q===h){p=n.Y;k=n.X+g.getConf().dot.indent+m[r.type]*g.getConf().dot.offset;o=g.getConf().dot.color2}if(q===f){p=n.Y+n._.size;k=n.X+g.getConf().dot.indent;o=g.getConf().dot.color2}this.addDot(r,1,[k,p],o);l.push(m[r.type]++)}else{l.push(void 0)}}return l};g.prototype.addElement=function(s){var C,G,z,H,E,x,N,A,F,B,y,I,D,u,r,p,n,J,K,l,M,w,v,t,q,o,m,k,L;F=g.getConf().element.size;E=g.getConf().icon.size;C=c.getConf(s.Name);if(s._==null){s._={}}if(s.Property==null){s.Property={}}if(s.Methods==null){s.Methods={}}s._.links=[];s._.conf=C;if(C.Property==null){C.Property={}}if(C.Methods==null){C.Methods={}}switch(s._.conf.Type.Class){case"MultiElement":if(s._Container.Property.EventCount){for(H=u=1,w=s._Container.Property.EventCount.Value;1<=w?u<=w:u>=w;H=1<=w?++u:--u){N="onEvent"+H;C.Methods[N]={Name:N,type:j,noVisible:-1}}}if(s._Container.Property.WorkCount){for(H=r=1,v=s._Container.Property.WorkCount.Value;1<=v?r<=v:r>=v;H=1<=v?++r:--r){z="doWork"+H;C.Methods[z]={Name:z,type:i,noVisible:-1}}}break;case"DPElement":t=s._.conf.Type.Sub.split(",");for(p=0,J=t.length;p<J;p++){B=t[p];if(B){q=B.split("|"),G=q[0],N=q[1];if(N[0]==="o"){y=j}else{y=i}for(H=n=1,o=s.Property[G].Value;1<=o?n<=o:n>=o;H=1<=o?++n:--n){z=""+N+H;C.Methods[z]={Name:z,type:y,noVisible:-1}}}}break;case"Hub":F=15;E=10;m=s._.conf.Type.Sub.split(",");for(l=0,K=m.length;l<K;l++){B=m[l];if(B){k=B.split("|"),G=k[0],N=k[1];if(N[0]==="o"){y=j}else{y=i}for(H=M=1,L=s.Property[G].Value;1<=L?M<=L:M>=L;H=1<=L?++M:--M){z=""+N+H;C.Methods[z]={Name:z,type:y,noVisible:-1}}}}break;case"EditMulti":F=400;E=0}for(x in s.Methods){if((I=C.Methods)[x]==null){I[x]={}}C.Methods[x].Name=s.Methods[x].Name;C.Methods[x].path=s.Methods[x].path;C.Methods[x].to=s.Methods[x].to;C.Methods[x].noVisible=-1}for(A in s.Property){if((D=C.Property)[A]==null){D[A]={}}C.Property[A].path=s.Property[A].path;C.Property[A].to=s.Property[A].to;C.Property[A].noVisible=-1}s._.visual=this.paper.drawElement(s,F,E);s._.size=F;s._.paper=this.paper;s.Property=C.Property;s.Methods=C.Methods;s._.paper=this.paper;return s};g.prototype.addDot=function(m,o,k,l){var n;m.Name=m.Name.replace(/%(.*)%/gmi,"");if((n=m._).type==null){n.type=o}m._.x=k[0];m._.y=k[1];m._.paper=this.paper;return m._.visual=this.paper.drawDot(m,o,k,l)};g.prototype.drawLink=function(k,s,q){var o,m,r,v,t,p,n,u,l;if(!s.Method||!s.Method._.x){console.error("точка "+s.Name+" остутствует в "+s.Element.Name);return false}o=k._.element;m=s.Element;v=k._.x-getConf().dot.radius.min/2;t=k._.y-getConf().dot.radius.min/2;p=s.Method._.x-getConf().dot.radius.min/2;n=s.Method._.y-getConf().dot.radius.min/2;console.log("draw link "+k.Name+"<-->"+s.Name);r=o._.paper.drawLink([v,t],[p,n],q);if((u=o._).links==null){u.links=[]}if((l=m._).links==null){l.links=[]}o._.links.push(r);m._.links.push(r);k._.link=r;s.Method._.link=r;r.dot1=k;r.dot2=s.Method;r.el1=o;return r.el2=m};return g})()}).call(this);